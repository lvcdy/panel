---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Search from "../components/Search.astro";
import LinkList from "../components/LinkList.astro";
import FloatingCtrl from "../components/FloatingCtrl.astro";
import Footer from "../components/Footer.astro";
import { BG_URL } from "../lib/config";
import "../styles/global.css";
---

<Layout bgUrl={BG_URL}>
  <script is:inline define:vars={{ BG_URL }}>
    const img = new Image();
    img.fetchPriority = "high";
    img.decoding = "async";
    img.src = BG_URL;
    img.onload = () => {
      document.documentElement.style.setProperty(
        "--bg-url",
        `url("${BG_URL}")`,
      );
      document.body.classList.add("bg-loaded");
    };
  </script>

  <main
    class="flex flex-col items-center min-h-screen relative z-10 text-white"
  >
    <Header />
    <Search />
    <LinkList />
    <Footer />
  </main>

  <FloatingCtrl />

  <script>
    import { fetchAndDetectProvider } from "../lib/provider";
    import {
      createElementCache,
      filterLinks,
      showSearchTip,
      updateTime,
      setupEngineButtonHandler,
      setupEngineItemHandlers,
      setupInputHandlers,
      setupSearchButtonHandler,
      setupFloatingButtonHandler,
      setupScrollListener,
      setupDocumentClickHandler,
      setupIPInfoHandler,
      setupCategoryCollapse,
      scheduleInit,
      DEFAULT_SEARCH_URL,
      loadCachedIcons,
      setupIconCaching,
      checkAllUrls,
      fetchIpInfo,
      fetchHitokoto,
    } from "../lib/main";

    const els = createElementCache();
    let searchUrl = DEFAULT_SEARCH_URL;

    setupIPInfoHandler(els.ipBox);

    // 搜索功能
    const doSearch = () => {
      if (els.input?.value.trim()) {
        window.open(
          searchUrl + encodeURIComponent(els.input.value.trim()),
          "_blank",
        );
      } else {
        showSearchTip(els.searchTip);
      }
    };

    // 初始化时间显示
    updateTime(els.clock, els.date);
    setInterval(() => updateTime(els.clock, els.date), 1000);

    // 初始化UI事件
    setupEngineButtonHandler(els.engineBtn, els.menu);
    setupEngineItemHandlers(els.menu, els.input, (url, iconClass) => {
      searchUrl = url;
      if (els.icon) {
        els.icon.className = `${iconClass} text-xl text-white/80 transition-all`;
      }
    });

    setupInputHandlers(
      els.input,
      els.searchTip,
      () => doSearch(),
      (query) => filterLinks(query),
    );

    setupSearchButtonHandler(els.searchBtn, () => doSearch());
    setupFloatingButtonHandler(els.floatingSearchBtn, els.input);
    setupScrollListener(els.floatingSearchBtn);
    setupDocumentClickHandler(els.menu);
    setupCategoryCollapse();

    // 初始化图标缓存
    loadCachedIcons();
    setupIconCaching();

    // 异步加载网络信息和URL状态检测
    scheduleInit(() => {
      const initNetworkData = async () => {
        await fetchIpInfo(els.ip, els.ipBox);
        await fetchAndDetectProvider(els.proName, els.proBox);
      };

      initNetworkData().catch((err) => {
        console.error("初始化网络数据失败:", err);
      });
    });

    // 获取随机一言作为占位符
    scheduleInit(() => {
      fetchHitokoto(els.input);
    });

    // 检测URL状态
    scheduleInit(() => {
      checkAllUrls();
    });
  </script>
</Layout>
