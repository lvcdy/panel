---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Search from "../components/Search.astro";
import LinkList from "../components/LinkList.astro";
import FloatingCtrl from "../components/FloatingCtrl.astro";
import Footer from "../components/Footer.astro";
import "../styles/global.css";
---

<Layout>
  <main
    class="flex flex-col items-center min-h-screen relative z-10 text-white"
  >
    <Header />
    <Search />
    <LinkList />
    <Footer />
  </main>

  <FloatingCtrl />

  <script>
    import { fetchAndDetectProvider } from "../lib/provider";
    import * as UI from "../lib/main";
    import { initBackgroundImage } from "../lib/background";

    initBackgroundImage();

    const els = UI.createElementCache();
    let searchUrl = UI.DEFAULT_SEARCH_URL;

    UI.setupIPInfoHandler(els.ipBox);

    // 搜索功能
    const doSearch = () => {
      if (els.input?.value.trim()) {
        window.open(
          searchUrl + encodeURIComponent(els.input.value.trim()),
          "_blank",
        );
      } else {
        UI.showSearchTip(els.searchTip);
      }
    };

    // 初始化时间显示
    UI.updateTime(els.clock, els.date);
    setInterval(() => UI.updateTime(els.clock, els.date), 1000);

    // 初始化UI事件
    UI.setupEngineButtonHandler(els.engineBtn, els.menu);
    UI.setupEngineItemHandlers(
      els.menu,
      els.input,
      (url: string, iconClass: string) => {
        searchUrl = url as typeof UI.DEFAULT_SEARCH_URL;
        if (els.icon) {
          els.icon.className = `${iconClass} text-xl text-white/80 transition-all`;
        }
      },
    );

    UI.setupInputHandlers(
      els.input,
      els.searchTip,
      () => doSearch(),
      (query) => UI.filterLinks(query),
    );

    UI.setupSearchButtonHandler(els.searchBtn, () => doSearch());
    UI.setupFloatingButtonHandler(els.floatingSearchBtn, els.input);
    UI.setupScrollListener(els.floatingSearchBtn);
    UI.setupDocumentClickHandler(els.menu);
    UI.setupCategoryCollapse();

    // 初始化图标缓存
    UI.loadCachedIcons();
    UI.setupIconCaching();

    // 异步加载网络信息和URL状态检测
    UI.scheduleInit(() => {
      const initNetworkData = async () => {
        await UI.fetchIpInfo(els.ip, els.ipBox);
        await fetchAndDetectProvider(els.proName, els.proBox);
      };

      initNetworkData().catch((err) => {
        console.error("初始化网络数据失败:", err);
      });
    });

    // 获取随机一言作为占位符
    UI.scheduleInit(() => {
      UI.fetchHitokoto(els.input);
    });

    // 检测URL状态
    UI.scheduleInit(() => {
      UI.checkAllUrls();
    });
  </script>
</Layout>
