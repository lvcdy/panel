---
import Layout from "../layouts/Layout.astro";
import Footer from "../components/Footer.astro";
import { CATEGORIES, SEARCH_ENGINES } from "../data/links";
import "../styles/global.css";

const ICON_API = "https://ico.kucat.cn/get.php?url=";
const BG_URL = "https://t.alcy.cc/ycy";
---

<Layout>
  <script is:inline define:vars={{ BG_URL }}>
    // 背景预加载逻辑
    const img = new Image();
    img.src = BG_URL;
    img.onload = () => {
      document.documentElement.style.setProperty('--bg-url', `url("${BG_URL}")`);
      document.body.classList.add('bg-loaded');
    };
  </script>

  <main class="flex flex-col items-center min-h-screen relative z-10 text-white">
    <div class="mt-24 text-center select-none">
      <h1 id="clock" class="text-7xl font-bold tracking-tight drop-shadow-2xl">--:--:--</h1>
      <p id="date" class="text-xl font-medium opacity-90 mt-1">正在初始化...</p>
      <div id="ip-info" class="mt-4 inline-flex items-center gap-2 px-4 py-1.5 rounded-full border border-white/10 text-xs text-white/70 opacity-0 transition-opacity duration-700">
        <i class="fas fa-location-dot text-[10px]"></i>
        <span id="ip-address">正在定位...</span>
      </div>
    </div>

    <div class="mt-12 w-full max-w-[650px] px-6 relative">
      <div class="glass flex items-center h-16 rounded-2xl px-2 shadow-2xl">
        <div id="engineBtn" class="w-12 h-12 flex items-center justify-center rounded-xl cursor-pointer hover:bg-white/10 transition-all">
          <i id="currentIcon" class="fas fa-paw text-xl text-white/80"></i>
        </div>
        <input type="text" id="searchInput" placeholder="正在加载一言..." class="bg-transparent flex-grow h-full px-4 outline-none placeholder-white/40 font-medium" />
        <i class="fas fa-search mr-4 opacity-40"></i>
      </div>
      <div id="engineMenu" class="glass absolute top-[75px] left-6 w-44 rounded-2xl hidden flex-col z-50 shadow-2xl overflow-hidden">
        {SEARCH_ENGINES.map(e => (
          <div class="engine-item p-4 hover:bg-white/20 cursor-pointer flex items-center gap-4 text-sm font-medium" data-url={e.url} data-icon={e.icon}>
            <i class={`${e.icon} w-5 text-center`} />
            <span>{e.name}</span>
          </div>
        ))}
      </div>
    </div>

    <div class="w-full max-w-[1500px] px-10 mt-12 flex-grow">
      {CATEGORIES.map(cat => (
        <div class="mb-10">
          <h2 class="text-2xl font-bold mb-6 pl-2 drop-shadow-md">{cat.title}</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-5">
            {cat.links.map(link => (
              <a href={link.url} target="_blank" class="glass sun-card flex items-center p-5 rounded-[1.8rem] group">
                <div class="w-12 h-12 flex-shrink-0 rounded-2xl bg-white/10 flex items-center justify-center overflow-hidden p-2.5 text-2xl">
                  <img src={ICON_API + link.url} loading="lazy" class="w-full h-full object-contain transition-opacity opacity-0" onload="this.style.opacity=1" onerror="this.nextElementSibling.classList.remove('hidden');this.remove()" />
                  <div class="hidden w-full h-full flex items-center justify-center" style={`color:${link.color}`}><i class={link.icon} /></div>
                </div>
                <div class="ml-4 overflow-hidden text-white/90 font-bold truncate">{link.name}</div>
              </a>
            ))}
          </div>
        </div>
      ))}
    </div>

    <Footer />
  </main>

  <script is:inline>
    (function () {
      const d = document, $ = (id) => d.getElementById(id);
      const clock = $('clock'), dateEl = $('date'), ipText = $('ip-address'), ipBox = $('ip-info'), 
            input = $('searchInput'), engineBtn = $('engineBtn'), engineMenu = $('engineMenu'), currentIcon = $('currentIcon');
      let searchUrl = "https://www.baidu.com/s?wd=", hitokoto = "欢迎回来";

      // 1. 时钟
      setInterval(() => {
        const now = new Date();
        clock.innerText = now.toTimeString().split(' ')[0];
        dateEl.innerText = now.toLocaleDateString('zh-CN', {month:'long',day:'numeric',weekday:'long'});
      }, 1000);

      // 2. 初始化逻辑
      const init = async () => {
        // --- 遵循 UAPI 最新示例调用 ---
        try {
          const res = await fetch('https://uapi.cn/api/v1/network/myip');
          const json = await res.json();
          if (json.code === 200) {
            const r = json.data;
            // 拼接：IP · 省份 城市 · 运营商
            ipText.innerText = `${r.ip} · ${r.province} ${r.city} · ${r.isp}`;
          }
        } catch (e) {
          // 容错回退
          ipText.innerText = "Welcome Back";
        }
        ipBox.style.opacity = 1;

        // --- 服务商识别 ---
        try {
          const res = await fetch(window.location.href, { method: 'HEAD' });
          const s = (res.headers.get('server') || '').toLowerCase(), k = [...res.headers.keys()].join(' ');
          const pT = $('pro-name'), pB = $('pro-info');
          if(pT && pB) {
            pT.innerText = (k.includes('ali-ray') || s.includes('esa')) ? "Alibaba Cloud ESA" : (k.includes('cf-ray') || s.includes('cloudflare')) ? "Cloudflare Edge" : "Global Edge Network";
            pB.style.opacity = 1;
          }
        } catch {}

        // --- 一言 ---
        fetch("https://v1.hitokoto.cn/?c=i").then(r=>r.json()).then(data => {
          input.placeholder = hitokoto = `${data.hitokoto} —— 「${data.from}」`;
        }).catch(()=>{});
      };

      // 3. 交互逻辑
      engineBtn.onclick = (e) => { e.stopPropagation(); engineMenu.classList.toggle("hidden"); };
      d.querySelectorAll(".engine-item").forEach(item => {
        item.onclick = (e) => {
          searchUrl = e.currentTarget.dataset.url;
          currentIcon.className = e.currentTarget.dataset.icon + " text-xl text-white/80 transition-all";
          engineMenu.classList.add("hidden");
          input.focus();
        };
      });

      input.onkeypress = (e) => {
        if (e.key === "Enter" && input.value.trim()) window.open(searchUrl + encodeURIComponent(input.value.trim()), "_blank");
      };

      d.onclick = () => engineMenu.classList.add("hidden");
      input.onfocus = () => input.placeholder = "请输入搜索内容...";
      input.onblur = () => { if(!input.value) input.placeholder = hitokoto; };

      init();
    })();
  </script>
</Layout>