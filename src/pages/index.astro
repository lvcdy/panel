---
import Layout from "../layouts/Layout.astro";
import Footer from "../components/Footer.astro";
import { CATEGORIES, SEARCH_ENGINES } from "../data/links";
import "../styles/global.css";

const ICON_API = "https://ico.kucat.cn/get.php?url=";
const BG_URL = "https://t.alcy.cc/ycy";
---

<Layout bgUrl={BG_URL}>
  <script is:inline define:vars={{ BG_URL }}>
    const img = new Image();
    img.fetchPriority = "high";
    img.decoding = "async";
    img.src = BG_URL;
    img.onload = () => {
      document.documentElement.style.setProperty(
        "--bg-url",
        `url("${BG_URL}")`,
      );
      document.body.classList.add("bg-loaded");
    };
  </script>

  <main
    class="flex flex-col items-center min-h-screen relative z-10 text-white"
  >
    <div class="mt-24 text-center select-none">
      <h1 id="clock" class="text-7xl font-bold tracking-tight drop-shadow-2xl">
        --:--:--
      </h1>
      <p id="date" class="text-xl font-medium opacity-90 mt-1">载入中...</p>
      <div
        id="ip-info"
        class="mt-4 inline-flex items-center gap-2 px-4 py-1.5 rounded-full border border-white/10 text-xs text-white/70 opacity-0 transition-opacity duration-1000"
      >
        <i class="fas fa-location-dot text-[10px]"></i>
        <span id="ip-address">正在同步网络数据...</span>
      </div>
    </div>

    <div class="mt-12 w-full max-w-[650px] px-6 relative">
      <div class="glass flex items-center h-16 rounded-2xl px-2 shadow-2xl">
        <div
          id="engineBtn"
          class="w-12 h-12 flex items-center justify-center rounded-xl cursor-pointer hover:bg-white/10 transition-all"
        >
          <i id="currentIcon" class="fas fa-paw text-xl text-white/80"></i>
        </div>
        <input
          type="text"
          id="searchInput"
          placeholder="正在思考..."
          class="bg-transparent flex-grow h-full px-4 outline-none placeholder-white/40 font-medium"
        />
        <i class="fas fa-search mr-4 opacity-40"></i>
      </div>
      <div
        id="engineMenu"
        class="glass absolute top-[75px] left-6 w-44 rounded-2xl hidden flex-col z-50 shadow-2xl overflow-hidden"
      >
        {
          SEARCH_ENGINES.map((e) => (
            <div
              class="engine-item p-4 hover:bg-white/20 cursor-pointer flex items-center gap-4 text-sm font-medium"
              data-url={e.url}
              data-icon={e.icon}
            >
              <i class={`${e.icon} w-5 text-center`} />
              <span>{e.name}</span>
            </div>
          ))
        }
      </div>
    </div>

    <div class="w-full max-w-[1500px] px-10 mt-12 flex-grow">
      {
        CATEGORIES.map((cat) => (
          <div class="mb-10">
            <h2 class="text-2xl font-bold mb-6 pl-2 drop-shadow-md">
              {cat.title}
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-5">
              {cat.links.map((link) => (
                <a
                  href={link.url}
                  target="_blank"
                  class="glass sun-card flex items-center p-5 rounded-[1.8rem] group"
                >
                  <div class="w-12 h-12 flex-shrink-0 rounded-2xl bg-white/10 flex items-center justify-center overflow-hidden p-2.5 text-2xl">
                    <img
                      src={ICON_API + link.url}
                      loading="lazy"
                      decoding="async"
                      fetchpriority="low"
                      class="w-full h-full object-contain transition-opacity opacity-0"
                      onload="this.style.opacity=1"
                      onerror="this.nextElementSibling.classList.remove('hidden');this.remove()"
                    />
                    <div
                      class="hidden w-full h-full flex items-center justify-center"
                      style={`color:${link.color}`}
                    >
                      <i class={link.icon} />
                    </div>
                  </div>
                  <div class="ml-4 overflow-hidden text-white/90 font-bold truncate">
                    {link.name}
                  </div>
                </a>
              ))}
            </div>
          </div>
        ))
      }
    </div>
    <Footer />
  </main>

  <script>
    import { client } from "../lib/uapi";

    (function () {
      const $ = (s: string) => document.querySelector(s) as HTMLElement;
      const els = {
        clock: $("#clock"),
        date: $("#date"),
        ip: $("#ip-address"),
        ipBox: $("#ip-info"),
        input: $("#searchInput") as HTMLInputElement,
        engineBtn: $("#engineBtn"),
        menu: $("#engineMenu"),
        icon: $("#currentIcon"),
        proName: $("#pro-name"),
        proBox: $("#pro-info"),
      };

      let searchUrl = "https://www.baidu.com/s?wd=";

      const updateTime = () => {
        const now = new Date();
        if (els.clock)
          els.clock.innerText = now.toLocaleTimeString("zh-CN", {
            hour12: false,
          });
        if (els.date)
          els.date.innerText = now.toLocaleDateString("zh-CN", {
            month: "long",
            day: "numeric",
            weekday: "long",
          });
      };
      setInterval(updateTime, 1000);
      updateTime();

      const initData = async () => {
        try {
          const res: any = await client.network.getNetworkMyip({
            _t: Date.now(),
          });
          const r = res?.data || res;
          if (r?.ip && els.ip) {
            const operator = r.llc || r.isp || "";
            let loc = r.region && r.region !== "未知地区" ? r.region : "";
            if (r.district && r.district !== "未知") loc += ` ${r.district}`;
            els.ip.innerText = [r.ip, operator, loc]
              .filter(Boolean)
              .join(" · ");
          }
        } catch {
          if (els.ip) els.ip.innerText = "Enjoy your day";
        } finally {
          if (els.ipBox) els.ipBox.style.opacity = "1";
        }

        try {
          const res = await fetch(window.location.href, {
            method: "HEAD",
            cache: "no-cache",
          });
          const s = (res.headers.get("server") || "").toLowerCase();
          const k = [...res.headers.keys()].join(" ");
          if (els.proName && els.proBox) {
            let providerName = "";
            let providerUrl = "";

            if (k.includes("ali-ray") || s.includes("esa")) {
              providerName = "Alibaba Cloud ESA";
              providerUrl = "https://www.aliyun.com/product/esa";
            } else if (k.includes("cf-ray") || s.includes("cloudflare")) {
              providerName = "Cloudflare Edge";
              providerUrl = "https://www.cloudflare.com/";
            } else {
              providerName = "Global Edge Network";
            }

            els.proName.innerText = providerName;

            if (providerUrl) {
              els.proBox.onclick = (e) => {
                e.stopPropagation();
                window.open(providerUrl, "_blank");
              };
            }
            els.proBox.style.opacity = "1";
          }
        } catch {
          if (els.proName) els.proName.innerText = "Edge Service";
        }

        fetch("https://v1.hitokoto.cn/?c=i")
          .then((r) => r.json())
          .then((d) => {
            if (els.input)
              els.input.placeholder = `${d.hitokoto} —— 「${d.from}」`;
          })
          .catch(() => {
            if (els.input) els.input.placeholder = "永远相信美好的事情即将发生";
          });
      };

      const scheduleInit = (cb: () => void) => {
        const ric = (window as any).requestIdleCallback;
        if (ric) {
          ric(cb, { timeout: 1200 });
        } else {
          setTimeout(cb, 200);
        }
      };
      if (els.engineBtn) {
        els.engineBtn.onclick = (e) => {
          e.stopPropagation();
          els.menu?.classList.toggle("hidden");
        };
      }

      document.querySelectorAll(".engine-item").forEach((item) => {
        (item as HTMLElement).onclick = (e) => {
          const target = e.currentTarget as HTMLElement;
          searchUrl = target.dataset.url || searchUrl;
          if (els.icon)
            els.icon.className = `${target.dataset.icon} text-xl text-white/80 transition-all`;
          els.menu?.classList.add("hidden");
          els.input?.focus();
        };
      });

      if (els.input) {
        els.input.onkeydown = (e) => {
          if (e.key === "Enter" && els.input.value.trim())
            window.open(
              searchUrl + encodeURIComponent(els.input.value.trim()),
              "_blank",
            );
        };
      }

      document.onclick = () => els.menu?.classList.add("hidden");
      scheduleInit(initData);
    })();
  </script>
</Layout>
